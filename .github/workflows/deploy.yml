name: Deploy to AkileCloud

# è§¦å‘æ¡ä»¶ï¼šå½“ main åˆ†æ”¯æœ‰ä»£ç æ¨é€æ—¶
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          # æœºå™¨äººè¿ä¸ŠæœåŠ¡å™¨åè¦æ‰§è¡Œçš„å‘½ä»¤
          script: |
            # 1. è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/stockwise
            
            # 2. å¼ºåˆ¶ä¸¢å¼ƒæœåŠ¡å™¨ä¸Šçš„æœ¬åœ°ä¿®æ”¹ï¼Œä¸ GitHub ä¿æŒä¸€è‡´ (é˜²æ­¢å†²çª)
            git fetch --all
            git reset --hard origin/main
            git pull
            
            # 3. å®‰è£…ä¾èµ–å¹¶æ‰“åŒ…
            # (å¦‚æœä¾èµ–æ²¡å˜ï¼Œnpm install ä¼šå¾ˆå¿«)
            npm install
            npm run build
            
            # 4. éƒ¨ç½²åˆ° Nginx ç›®å½•
            rm -rf /root/vet-app/html/*
            cp -r dist/* /root/vet-app/html/
            
            # 5. (å¯é€‰) å¦‚æœä¸éœ€è¦æ”¹ Nginx é…ç½®ï¼Œå…¶å®ä¸ç”¨é‡å¯ Docker
            # ä½†ä¸ºäº†ä¿é™©ï¼Œå¯ä»¥é‡å¯ä¸€ä¸‹ Nginx å®¹å™¨
            # cd /root/vet-app && docker-compose restart web
            
            echo "Deployment Successful! ğŸš€"
